<!doctype html>
<head>
    <meta charset="utf-8">
    <title>FILE→SVG</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="./js/psd.min.js"></script>
    <script type="text/javascript" src="./js/snap.svg-min.js"></script>
    <script type="text/javascript" src="./js/fabric.min.js"></script>
    <script type="text/javascript" src="./js/filetosvg.js"></script>
    <script type="text/javascript" src="./js/canvas.js"></script>

    <script type="text/javascript">

        window.addEventListener("DOMContentLoaded", function(){

            var canvas = new Canvas('canvas');
            var PSD = require('psd');

            //ファイルオープンの際のイベント
            document.getElementById("selectfile").addEventListener("change", function(evt) {

                var file = evt.target.files[0];     // ファイル情報
                var ext = file['name'].slice(-4).toUpperCase();   // 拡張子
                var reader = new FileReader();
                var retSvgStr = "";

                if (ext == '.SVG') {
                    // SVGの読み込み
                    reader.onload = function(e) {
                        var svgString = e.target.result;
                        var colorArray = [];
                        retSvgStr = svgToSvg(svgString, colorArray);

                        // 色の重複を削除
                        colorArray = colorArray.filter(function (x, i, self) {
                                        return self.indexOf(x) === i;
                                    });

                        // canvasに表示
                        canvas.addObj(retSvgStr);

                        // ファイルに保存
                        //saveFile(retSvgStr, 'svg.svg');
                    };
                    reader.readAsText(file);
                }
                else if (ext == '.DXF') {
                    // DXFの読み込み
                    reader.onload = function(e) {
                        var dxfString = e.target.result;
                        retSvgStr = dxfToSvg(dxfString);

                        // canvasに表示
                        canvas.addObj(retSvgStr);

                        // ファイルに保存
                        //saveFile(retSvgStr, 'dxf.svg');
                    };
                    reader.readAsText(file);
                }
                else if (ext == '.PSD') {
                    // PSDの読み込み
                    reader.onload = function(e) {
                        var psd;
                        psd = new PSD(new Uint8Array(e.target.result));
                        psd.parse();

                        var img = psd.image.toPng();
                        retSvgStr = imgToSvg(img);

                        // canvasに表示
                        canvas.addObj(retSvgStr);

                        // ファイルに保存
                        //saveFile(retSvgStr, 'psd.svg');
                    };
                    reader.readAsArrayBuffer(file);
                }
                else if (ext == '.JPG' || ext == '.BMP' || ext == '.PNG' ||
                         ext == '.TIF' || ext == '.GIF') {

                    //ファイルの読込が終了した時の処理
                    reader.onload = function(e) {
                        var img = new Image();

                        img.onload = function(){
                            retSvgStr = imgToSvg(img);

                            // canvasに表示
                            canvas.addObj(retSvgStr);

                            // ファイルに保存
                            //saveFile(retSvgStr, 'image.svg');
                        }

                        img.src = e.target.result;

                    }
                    reader.readAsDataURL(file);     // dataURL形式でファイルを読み込む
                }

            }, false);
        });

        function saveFile(svgString, fileName){
            var blob = new Blob([ svgString ], { "type" : "text/plain" });
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.target = '_blank';
            a.download = fileName;
            a.click();
        }
        function saveSvg(){
            var svgString = canvas.toSVG();
            saveFile(svgString, 'canvas.svg');
        }

    </script>
</head>
<body>
    <h1>FILE→SVG</h1>
    <div>
        <input type="file" id="selectfile">
        <input type="button" value="ファイルに保存" onClick="saveSvg()">
    </div>
    <div style="margin-top:10px; margin-bottom:10px;">
        <input type="button" value="Undo" onClick="canvas.undo()">
        <input type="button" value="Redo" onClick="canvas.redo()">
        <input type="button" value="Copy" onClick="canvas.copy()">
        <input type="button" value="Paste" onClick="canvas.paste()">
        <input type="button" value="Delete" onClick="canvas.delete()">
    </div>
    <canvas id="canvas" width="1000" height="800" style="border:1px solid;"></canvas>
</body>
</html>
